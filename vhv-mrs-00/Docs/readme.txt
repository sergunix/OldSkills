Автоматизация процесса выкачивания по FTP файлов репликаций НСИ
и накладных, а также обновлений программных модулей и скриптов БД.

Добрый день господа админы!

Волховское ЛПУМГ в лице Сергеева С.Г. и моего временного помощника 
от службы КИПиА Филина М.А. представляет вам на рассмотрение и,
по Вашему желанию, внедрение у себя процедуры упрощения процесса 
выкачивания по FTP файлов репликаций НСИ и накладных, а также 
обновлений программных модулей и скриптов БД.

Всем известно, что, к сожалению, современная технология МиКС и сервера 
MSSQL 2000 от широко известной фирмы не позволяет нам жить 
автоматизированно. Как бы в идеале хотелось чтобы репликация БД
проходила автоматически и незаметно для нас и только по возникновении 
ошибок передачи и/или приема системному администратору посылалось
треворжное сообщение с требованием разобраться что там не 
так как надо пошло. Но это в будущем, может быть.
Пока что вручную (или может быть у кого-нибудь уже и нет) нам
приходится периодически залезать на FTP, смотреть чего там новенького,
качать, а потом еще и устанавливать.

Итак, приступим к частичной автоматизации этого процесса.
Естественно, такие задачи легко решаются скриптами на языках shell 
Unix. Но только ради Вас, инженера АСУ, мы попробуем сделать это
под ДОС.

У нас имеются две задачи:
------------------------------
1. По нескольку раз в день закачивать обновления программных 
компонентов МиКС и скриптов БД. 
	Для этого мы изготовили для Вас командный файл wgetmics.cmd
	В качестве параметра он принимает текущий месяц и день 
	wgetmics.cmd 03-27
	Чтобы автоматически получать текущий месяц-день пришлось писать
	утилиту monday.exe которая без параметров выдает текущий месяц-день
	А если в качесте параметра внести командный файл, в нашем случае так:
	monday.exe wgetmics.cmd, то утилита запустит командный файл и передаст
	ему параметр - текущий месяц и день.

	Краткий алгоритм-
		Идем в рабочий каталог, туда куда надо ложить 
		обновления МиКСа.
		
		С помощью портированной из Unix утилиты wget качаем
		файлы обновлений БД и программ из корня каталога MIKS
		FTP-сервера и из каталогов с текущим днем МЕСЯЦ-ДЕНЬ-*

		С помощью портированной из Unix утилиты grep выделяем из
		протокола о закачке данные о закачанных файлах
		
		И если что-то закачали, то посылаем известие об этом на 
		почту администратора сети.

	Для успешной работы wgetmics.cmd Вам необходимо настроить его
	внутренние параметры:

	REM Имя файла протокола закачки
	set LOGFILE=log_mics.txt

	REM Адрес SMTP сервера электронной почты
	set SMTP=mail.vhv.ltg.ru

	REM Получатель отчета о загрузке файлов
	set MAIL_TO=root@vhv.ltg.ru

	REM Отправитель отчета
	set MAIL_FROM=mics@vhv.ltg.ru

2. По нескольку раз в день закачивать обновления справочников НСИ и накладных.
	Для этого мы изготовили для Вас командный файл wgetnsi.cmd

	Краткий алгоритм-
		Идем в рабочий каталог, туда куда надо ложить 
		обновления справочников МиКСа.
		
		С помощью портированной из Unix утилиты wget качаем
		файлы НСИ и накладных из корня каталога Mrs FTP-сервера
		для заданного кода ЛПУ, кроме каталогов /Mrs/MRS_BACK и
                /Mrs/MRS_BUH 

		С помощью портированной из Unix утилиты grep выделяем из
		протокола о закачке данные о закачанных файлах
		
		И если что-то закачали, то
		!ВНИМАНИЕ!
		С сервера FTP удаляются файлы по шаблону КОД_ЛПУ*, при том все,
		возможно, даже и не закачанные, но такое может произойти только
		теоретически. Так как процедура удаления с FTP закачанных файлов
		выполняется только, если что-то было закачено.
		mrs.del
		--------------------------	
		open 10.9.16.251
		user miks miks
		cd Mrs
		mdelete 13@*.mrs
		cd MRS_NAKL
		mdelete BNZ13*.*
		quit

		Этот момент требует доработки. Может кто подскажет как выделить
		имена закачанных файлов и удалить только их, не трогая других.
		Дальше посылаем известие о закачанных файлах на почту 
		администратора сети.
		
		Если же ничего не закачали, то выходим.


	Для успешной работы wgetnsi.cmd Вам необходимо настроить его
	внутренние параметры:

	REM Код ЛПУ по классификации МиКС
	set LPU=13

	REM Имя файла протокола закачки
	set LOGFILE=log_mics.txt

	REM Адрес SMTP сервера электронной почты
	set SMTP=mail.vhv.ltg.ru

	REM Получатель отчета о загрузке файлов
	set MAIL_TO=root@vhv.ltg.ru

	REM Отправитель отчета
	set MAIL_FROM=mics@vhv.ltg.ru
	
	А также подправьте под себя файл mrs.del: поставьте удаление 
	файлов с кодом своего ЛПУ!


Для одновременного и периодического запуска наших задач: wgetmics.cmd
и wgetnsi.cmd придется использовать возможности Windows NT.
Создадим файл getmics.cmd для одновременного запуска двух задач.

Запускаем программулю WinAT.exe и настраиваем запуск getmics.cmd
четыре раза в день и семь дней в неделю в 9:00, 12:30, 15:00, 23:30. 
Наверное, этого пока достаточно.

Установка на диск
------------------------
1. Выбрать рабочий каталог, где хранятся командные файлы и протоколы
Переписать туда
getmics.cmd, wgetmics.cmd, wgetnsi.cmd, mrs.del, monday.exe
SENDMAIL.EXE, SENDMAIL.INI, license.txt

2. Из этого рабочего каталога исходят подкаталог с обновлениями 
НСИ, накладных (_Replication) и с обновлениями программ и скриптов
(MICS2002)

3. По пути прописанному в переменной PATH, необходимо положить файлы
LIBEAY32.DLL, SSLEAY32.DLL, WGET.EXE, 
GREP.EXE, winat.exe - У МЕНЯ это c:\sys


Еще раз о подводных камнях (или на что надо обратить особое внимание):
------------------------------------------------------------------------
1. Скорректируйте именно под себя (свое ЛПУ) файл mrs.del !!!!!!!!!!!!
!!! Не используйте наш вариант, иначе будете случайно удалять наши файлы !!!
2. Рабочие каталоги находятся локально на сервере, на котором собственно 
и выполняется закачка (можете попробовать по-своему). 
Настройте в командных файлах свои рабосие каталоги.
3. Надо поставить в автозагрузку службу scheduler на сервере c задачей WinAT.


Чтобы хотелось сделать (переделать) еще, возможно с Вашей помощью.
---------------------------------------------------------------------
1. Удалять то что принято с FTP, а не все подряд по коду ЛПУ
Этот момент требует доработки. Может кто подскажет как выделить
имена закачанных файлов и удалить только их, не трогая других.
		
2. Включать в тело сообщения принятые файлы, а не отдельным файлом.

3. ЗАВИСИТ от РАЗРАБОТЧИКОВ МИКС:
Надо чтобы закачанные файлы репликаций справочников НСИ и накладных 
автоматом ставились в БД. Для этого надо дать разработчикам МиКС задание на 
изготовление модуля MRS2.EXE способного воспринимать параметры из командной
строки и работать в консольном режиме. Пример,
mrs2.exe d:\UPDATES\Replication 13 - загрузить следующий по порядку
				     файл 13@0000хх.mrs и если больше новых 
				     файлов нет, то прекратить работу

mrs2.exe d:\UPDATES\Replication NsiSch - загрузить текущий файл NsiSch.mrs

mrs2.exe d:\UPDATES\Replication\MRS_NAKL BNZ13 - загрузить следующий по порядку
				     	файл BNZ13*.mrs для филиала по списку
					и если больше новых  файлов нет, 
					то прекратить работу

Эта утилита должна возвращать код errorlevel, чтобы можно было проанализировать 
результат ее работы и в случае сбоев отослать сообщение администратору сети.

4. Может кто-нибудь из Вас придумает как сделать автоматическую отсылку на FTP
файлов сформированных для Управления и других филиалов. 


С пожеланием сотрудничества и плодотворной работы, 
Ваши инженера Волховского ЛПУМГ	Сергеев С.Г., Филин М.А. 
EMail: serges@vhv.ltg.ru, mixas@vhv.ltg.ru
